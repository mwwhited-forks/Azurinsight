name: Release

on:
  release:
    types: [created]

jobs:
  build:
    strategy:
      matrix:
        include:
          - target: win32-x64
            os: windows-latest
            npm_os: win32
            npm_cpu: x64
          - target: linux-x64
            os: ubuntu-latest
            npm_os: linux
            npm_cpu: x64
          - target: darwin-x64
            os: macos-latest
            npm_os: darwin
            npm_cpu: x64
          - target: darwin-arm64
            os: macos-latest
            npm_os: darwin
            npm_cpu: arm64

    runs-on: ${{ matrix.os }}
    steps:
    - uses: actions/checkout@v4

    - name: Use Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '24.x'
        cache: 'npm'

    - name: Install Dependencies
      run: npm ci

    - name: Install Linux Rollup Binding
      if: runner.os == 'Linux'
      run: npm install @rollup/rollup-linux-x64-gnu --no-save

    - name: Install Darwin Rollup Binding
      if: runner.os == 'macOS'
      run: |
        npm install @rollup/rollup-darwin-x64 --no-save --force
        npm install @rollup/rollup-darwin-arm64 --no-save --force

    - name: Build All Packages
      run: npm run build --workspaces

    - name: Prepare UI Assets
      shell: bash
      run: |
        mkdir -p packages/extension/ui/assets
        cp -r packages/ui/dist/* packages/extension/ui/
        cd packages/extension/ui/assets
        mv index-*.js index.js
        mv index-*.css index.css
    
    - name: Prepare Server Assets
      shell: bash
      run: |
        mkdir -p packages/extension/server/dist
        mkdir -p packages/extension/server/bin
        cp -r packages/server/dist/* packages/extension/server/dist/
        cp packages/server/package.json packages/extension/server/
        cd packages/extension/server
        npm install --os=${{ matrix.npm_os }} --cpu=${{ matrix.npm_cpu }}

    - name: Download Node.js Binary
      shell: bash
      run: |
        NODE_VERSION="v20.11.0"
        TARGET="${{ matrix.target }}"
        DEST="packages/extension/server/bin"
        TEMP_DIR="temp_node"
        mkdir -p $TEMP_DIR
        
        if [ "$TARGET" == "win32-x64" ]; then
          curl -L -o node.zip https://nodejs.org/dist/$NODE_VERSION/node-$NODE_VERSION-win-x64.zip
          unzip -j node.zip "*/node.exe" -d $DEST
          rm node.zip
        elif [ "$TARGET" == "linux-x64" ]; then
          curl -L -o node.tar.gz https://nodejs.org/dist/$NODE_VERSION/node-$NODE_VERSION-linux-x64.tar.gz
          tar -xzf node.tar.gz -C $TEMP_DIR
          cp $TEMP_DIR/node-$NODE_VERSION-linux-x64/bin/node $DEST/
          rm node.tar.gz
        elif [ "$TARGET" == "darwin-x64" ]; then
          curl -L -o node.tar.gz https://nodejs.org/dist/$NODE_VERSION/node-$NODE_VERSION-darwin-x64.tar.gz
          tar -xzf node.tar.gz -C $TEMP_DIR
          cp $TEMP_DIR/node-$NODE_VERSION-darwin-x64/bin/node $DEST/
          rm node.tar.gz
        elif [ "$TARGET" == "darwin-arm64" ]; then
          curl -L -o node.tar.gz https://nodejs.org/dist/$NODE_VERSION/node-$NODE_VERSION-darwin-arm64.tar.gz
          tar -xzf node.tar.gz -C $TEMP_DIR
          cp $TEMP_DIR/node-$NODE_VERSION-darwin-arm64/bin/node $DEST/
          rm node.tar.gz
        fi
        
        rm -rf $TEMP_DIR
        chmod +x $DEST/node*
        ls -la $DEST

    - name: Package Extension
      shell: bash
      run: |
        npm install -g @vscode/vsce
        cd packages/extension
        vsce package --target ${{ matrix.target }}
        ls -la

    - name: Get VSIX Path
      id: get_vsix_path
      shell: bash
      run: |
        VSIX_PATH=$(find packages/extension -name "azurinsight-${{ matrix.target }}*.vsix" -type f | head -n 1)
        echo "Found VSIX at: $VSIX_PATH"
        echo "vsix_path=$VSIX_PATH" >> $GITHUB_OUTPUT

    - name: Publish to VS Code Marketplace
      uses: HaaLeo/publish-vscode-extension@v1
      with:
        pat: ${{ secrets.VSCE_PAT }}
        registryUrl: https://marketplace.visualstudio.com
        extensionFile: ${{ steps.get_vsix_path.outputs.vsix_path }}
        packagePath: packages/extension
